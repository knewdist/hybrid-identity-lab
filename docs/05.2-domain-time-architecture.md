# 05.2 – Domain Time Architecture & Validation

## Objective

Validate proper enterprise time hierarchy after FSMO migration.

Ensure:

- Only the PDC Emulator syncs with external NTP
- All other domain controllers use domain hierarchy (NT5DS)
- Clients sync from domain controllers
- Kerberos time skew remains within 5 minutes
- No competing time authorities exist

---

# Phase 1 – Initial Observation (PDC Failure Simulation)

When DC02 (PDC Emulator) was powered off:

- DC01 reverted to Local CMOS Clock
- Clients continued authenticating
- Domain remained operational
- Time hierarchy temporarily degraded

This validated:

- Authentication does not require the PDC to be online
- RID allocation is not immediately dependent on the PDC
- AD multi-master replication remained functional

---

# Phase 2 – Issue Discovered

After bringing DC02 back online:

DC01 was still configured via Group Policy to use external NTP.

Resulting hierarchy:

DC01 → External NTP  
DC02 → External NTP  

This created multiple potential time authorities — an incorrect enterprise design.

Root cause:

Time configuration had been placed inside:

- Default Domain Policy
- Default Domain Controllers Policy

Group Policy was overriding local w32tm configuration.

---

# Phase 3 – Resolution

### 1. Removed Time Configuration from Default Policies

Cleared Windows Time settings from:

- Default Domain Policy
- Default Domain Controllers Policy

### 2. Configured DC02 (PDC Emulator)

- External NTP: 0.pool.ntp.org,1.pool.ntp.org
- Marked as reliable time source
- Confirmed proper stratum level

Command:

```
w32tm /query /status
```

### 3. Configured DC01

- Sync type: NT5DS (Domain Hierarchy)
- Manual peer list cleared
- Reliable flag disabled

Command:

```
w32tm /resync /rediscover
```

---

# Phase 4 – Validation

## 1️⃣ RID & SID Validation

Command:

```
Get-ADUser -Filter * | Select Name,SID
```

Confirmed proper RID sequencing.

Test user:

```
Get-ADUser ridtest01 | Select SID
```

Validated incremental RID allocation after FSMO migration.

---

## 2️⃣ Kerberos Ticket Validation

Command:

```
klist
```

Validated:

- TGT issued successfully
- AES-256 encryption
- Correct KDC referenced
- No time skew errors

---

## 3️⃣ Domain Controller Discovery

Command:

```
nltest /dsgetdc:corp.local
```

Confirmed:

- DC selection functioning
- Site awareness intact
- DNS resolution healthy

---

## 4️⃣ Time Hierarchy Validation

### DC02 (PDC Emulator)

```
w32tm /query /status
```

Validated:

- External NTP source
- Proper stratum level
- Authoritative time source

### DC01

```
w32tm /query /status
```

Validated:

- Source: DC02.corp.local
- Stratum incremented correctly
- Domain hierarchy intact

### CL01 (Client)

```
w32tm /query /status
```

Validated:

- Client syncing from domain controller
- Multi-level time chain functioning

---

# Final Verified Hierarchy

External NTP  
→ DC02 (PDC Emulator – Stratum 4)  
→ DC01 (Stratum 5)  
→ CL01 (Stratum 6)

This confirms correct enterprise time architecture.

---

# Architectural Lessons

- Only the PDC Emulator should sync from external NTP.
- All other DCs must use NT5DS (domain hierarchy).
- Group Policy overrides local w32tm configuration.
- Time is a Kerberos security boundary.
- Multiple authoritative time sources can cause replication and authentication instability.
- Default Domain Policies should not contain role-specific infrastructure configuration.

---

# Engineering Outcome

Validated:

- Multi-DC deployment
- FSMO role migration
- RID allocation integrity
- Kerberos ticket issuance
- PDC authoritative time role
- Proper domain time hierarchy reconstruction

This confirms enterprise-grade Active Directory time architecture.

---

# Screenshot Evidence

Below are the supporting screenshots captured during validation.

## RID Baseline

![RID Baseline](screenshots/05-time-01-rid-baseline.png)

---

## RID Allocation Test

![RID Allocation Test](screenshots/05-time-02-rid-test.png)

---

## Kerberos Ticket Validation

![Kerberos Ticket Validation](screenshots/05-time-03-klist.png)

---

## Domain Controller Discovery

![Domain Controller Discovery](screenshots/05-time-04-dsgetdc.png)

---

## DC02 – PDC Time Authority

![DC02 Time Status](screenshots/05-time-05-dc02-status.png)

---

## DC01 – Domain Hierarchy Sync

![DC01 Time Status](screenshots/05-time-06-dc01-status.png)

---

## CL01 – Client Time Sync

![Client Time Status](screenshots/05-time-07-client-status.png)

---
