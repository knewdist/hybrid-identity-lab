# 03.1 – Kerberos Authentication & PAC Authorization Flow

## Objective

Demonstrate and validate:

- Kerberos TGT issuance at logon
- PAC (Privilege Attribute Certificate) contents
- Service ticket issuance
- Authorization behavior after group membership changes
- Why logoff or TGT refresh is required

This lab validates identity plumbing inside Active Directory.

---

# Environment

Domain: corp.local  
Domain Controller: DC01  
File Server: FS01  
Client: CL01  
Test User: ivan.it  

Permission Model:

User → GG_Accounting → DL_Accounting_RW → NTFS ACL (\\FS01\Accounting)

---

# 1. Logon Process

User logs into CL01:

corp\ivan.it

During logon:

1. Client contacts DC01
2. DC issues TGT
3. TGT contains embedded PAC
4. PAC includes:
   - User SID
   - Group SIDs
   - Privileges
   - Signed by KRBTGT account
5. Windows builds local access token from PAC

Verification:

```powershell
klist
```

Primary ticket:

```
Server: krbtgt/CORP.LOCAL
Cache Flags: PRIMARY
```

---

# 2. Accessing a Network Resource

User accesses:

\\FS01\Accounting

Kerberos flow:

1. Client presents TGT to DC
2. DC issues service ticket: CIFS/FS01
3. Service ticket contains PAC copy
4. FS01 validates PAC signature
5. FS01 builds authorization token
6. NTFS ACL evaluated

Access is granted or denied based on PAC group SIDs.

---

# 3. Group Membership Change While Logged In

User ivan.it is added to:

- GG_Accounting
- Nested into DL_Accounting_RW

User remains logged in.

Verification:

```powershell
whoami /groups | findstr Accounting
```

Result:

(no output)

Access attempt:

\\FS01\Accounting

Result:

Access Denied

Reason:

- TGT was issued before group change
- PAC does not contain updated group SIDs
- FS01 trusts PAC, not live AD lookup

---

# 4. Kerberos Ticket Refresh

Tickets purged:

```powershell
klist purge
```

New TGT observed:

```powershell
klist
```

New Start Time confirms DC reissued TGT.

Validate membership:

```powershell
whoami /groups | findstr Accounting
```

Output:

CORP\GG_Accounting  
CORP\DL_Accounting_RW  

Access attempt:

\\FS01\Accounting

Result:

Access Granted

---

# 5. Why This Happens

Kerberos does NOT check group membership dynamically.

Authorization is based on:

PAC → Embedded in TGT → Copied into Service Ticket → Evaluated by Resource Server

If group membership changes:

- Existing TGT is stale
- PAC is stale
- Authorization fails
- New TGT required

---

# 6. Identity Flow Diagram

Logon
  ↓
DC issues TGT
  ↓
PAC embedded in TGT
  ↓
User requests resource
  ↓
Service ticket issued (CIFS/FS01)
  ↓
FS01 validates PAC signature
  ↓
Authorization token built
  ↓
NTFS ACL evaluated

---

# 7. Key Takeaways

- TGT contains PAC with group membership
- File servers do not query AD live for authorization
- Authorization is based on ticket contents
- Group changes require:
  - Logoff/Login OR
  - TGT refresh
- klist validates ticket lifecycle
- whoami /groups validates effective token SIDs
- Nested group model (AGDLP) works correctly

---

This confirms proper Kerberos and PAC lifecycle behavior in the lab.
